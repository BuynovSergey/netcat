<?php

use KubAT\PhpSimple\HtmlDomParser;

$DEFAULT_DOWNLOAD_ICON = "<svg width='21' height='21' viewBox='0 0 21 21' fill='none' xmlns='http://www.w3.org/2000/svg'>
                            <g clip-path='url(#clip0_1010_4602)'>
                                <path d='M1.191 13.1137C1.04918 12.9719 0.85682 12.8922 0.65625 12.8922C0.45568 12.8922 0.263325 12.9719 0.1215 13.1137C-0.0203238 13.2555 -0.1 13.4479 -0.1 13.6484V16.9297C-0.1 17.6524 0.187097 18.3455 0.698134 18.8566C1.20917 19.3676 1.90229 19.6547 2.625 19.6547H18.375C19.0977 19.6547 19.7908 19.3676 20.3019 18.8566C20.8129 18.3455 21.1 17.6524 21.1 16.9297V13.6484C21.1 13.4479 21.0203 13.2555 20.8785 13.1137C20.7367 12.9719 20.5443 12.8922 20.3438 12.8922C20.1432 12.8922 19.9508 12.9719 19.809 13.1137C19.6672 13.2555 19.5875 13.4479 19.5875 13.6484V16.9297C19.5875 17.2513 19.4598 17.5597 19.2324 17.7871C19.005 18.0144 18.6966 18.1422 18.375 18.1422H2.625C2.30342 18.1422 1.99502 18.0144 1.76763 17.7871C1.54025 17.5597 1.4125 17.2513 1.4125 16.9297V13.6484C1.4125 13.4479 1.33282 13.2555 1.191 13.1137Z' fill='#5B91F6' stroke='#5B91F6' stroke-width='0.2'/>
                                <path d='M11.2571 13.2681L13.903 10.6209L13.903 10.6209C14.045 10.4789 14.2375 10.3992 14.4383 10.3992C14.6391 10.3992 14.8317 10.4789 14.9737 10.6209C15.1156 10.7629 15.1954 10.9555 15.1954 11.1562C15.1954 11.357 15.1156 11.5496 14.9737 11.6916L11.0363 15.629L11.2571 13.2681ZM11.2571 13.2681V1.96875C11.2571 1.76818 11.1774 1.57583 11.0356 1.434C10.8938 1.29218 10.7014 1.2125 10.5008 1.2125C10.3003 1.2125 10.1079 1.29218 9.96608 1.434C9.82426 1.57582 9.74458 1.76818 9.74458 1.96875V13.2681L7.09868 10.6209L7.09867 10.6209C6.95669 10.4789 6.76412 10.3992 6.56333 10.3992C6.36254 10.3992 6.16997 10.4789 6.02799 10.6209C5.88601 10.7629 5.80625 10.9555 5.80625 11.1562C5.80625 11.357 5.88601 11.5496 6.02799 11.6916L9.9654 15.629L11.2571 13.2681ZM10.211 15.7934C10.1191 15.7553 10.0357 15.6995 9.96549 15.6291L10.211 15.7934ZM10.211 15.7934L10.2493 15.7011M10.211 15.7934L10.2493 15.7011M10.2493 15.7011L10.211 15.7934C10.3029 15.8315 10.4014 15.8512 10.5008 15.8512C10.6003 15.8512 10.6988 15.8315 10.7907 15.7934L10.7523 15.7011M10.2493 15.7011H10.7523M10.7523 15.7011L10.7907 15.7934C10.8825 15.7553 10.9659 15.6995 11.0362 15.6291L10.7523 15.7011Z' fill='#5B91F6' stroke='#5B91F6' stroke-width='0.2'/>
                            </g>
                            <defs>
                                <clipPath id='clip0_1010_4602'>
                                    <rect width='21' height='21' fill='white'/>
                                </clipPath>
                            </defs>
                        </svg>";


if (!function_exists("generate_table_of_contents")) {


    /**
     * @param string $html
     * @param int|string $row_id
     *
     * @return array
     */
    function generate_table_of_contents($html, $row_id) {
        $dom = HtmlDomParser::str_get_html($html);

        $font_classnames = array(
            "h1" => "tpl-text-default-big",
            "h2" => "tpl-text-default",
            "h3" => "tpl-text-default-small",
            "h4" => "tpl-text-default-small",
            "h5" => "tpl-text-default-smaller",
            "h6" => "tpl-text-default-smaller",
        );

        $last_level = 0;
        $i = 1;
        $toc = "";

        foreach ($dom->find("h1,h2,h3,h4,h5,h6") as $h) {
            $id = "toc-header-n-" . $row_id . "-" . $i++;
            $h->outertext = "<a name='$id'></a>" . $h->outertext;
            $level = intval($h->tag[1]);

            if ($level > $last_level) {
                $toc .= "<ul>";
            } else {
                $toc .= str_repeat("</li></ul>", $last_level - $level);
                $toc .= "</li>";
            }

            $toc .= "<li><a href='#$id' class='{$font_classnames[$h->tag]}'>$h->innertext</a>";
            $last_level = $level;
        }

        $toc .= str_repeat("</li></ul>", $last_level);
        $toc = preg_replace("#<br>|<br />|<br/>|</br>#", " ", $toc);
        $html_with_toc = $dom->save();

        $dom->clear();
        unset($dom);

        return array(
            "index" => $toc,
            "html" => $html_with_toc,
        );
    }
}
